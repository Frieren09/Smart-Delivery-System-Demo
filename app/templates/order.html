<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SmartDelivery - Place Order</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2 class="mb-4">ðŸ›’ Place Your Order</h2>

    <!-- ORDER FORM -->
    <form id="orderForm">
        <div class="row">
            {% for product in products %}
            <div class="col-md-4">
                <div class="product-card">
                    <h5>{{ product.name }}</h5>
                    <p>Price: ${{ product.price }}</p>
                    <p>Stock: {{ product.stock }}</p>
                    <input type="number"
                           class="form-control"
                           id="qty{{ product.product_id }}"
                           min="0"
                           max="{{ product.stock }}"
                           value="0">
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mb-3">
            <label class="form-label">Customer ID</label>
            <input type="number" id="customer_id" class="form-control" required>
        </div>

        <button class="btn btn-success">Place Order</button>
    </form>

    <!-- MESSAGE -->
    <div id="message" class="mt-4"></div>

    <!-- LIVE STATUS -->
    <div id="statusCard" class="mt-4"></div>
</div>

<script>
let currentOrderId = null;

// PLACE ORDER
document.getElementById("orderForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const customerId = document.getElementById("customer_id").value;
    const items = [];

    {% for product in products %}
    const qty{{ product.product_id }} = parseInt(document.getElementById("qty{{ product.product_id }}").value);
    if (qty{{ product.product_id }} > 0) {
        items.push({
            product_id: {{ product.product_id }},
            quantity: qty{{ product.product_id }}
        });
    }
    {% endfor %}

    fetch("/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            customer_id: parseInt(customerId),
            items: items
        })
    })
    .then(res => res.json())
    .then(data => {
        currentOrderId = data.orderId;

        document.getElementById("message").innerHTML =
            `<div class="alert alert-success">
                Order #${data.orderId} placed successfully!
            </div>`;

        document.getElementById("orderForm").reset();
        loadOrderStatus(); // load immediately
    });
});

// AUTO REFRESH ORDER STATUS
function loadOrderStatus() {
    if (!currentOrderId) return;

    fetch("/orders")
        .then(res => res.json())
        .then(orders => {
            const order = orders.find(o => o.order_id === currentOrderId);
            if (!order) return;

            document.getElementById("statusCard").innerHTML = `
                <div class="card shadow">
                    <div class="card-body">
                        <h5>ðŸ“¦ Order #${order.order_id}</h5>
                        <p><strong>Status:</strong>
                            <span class="badge ${
                                order.status === "Completed" ? "bg-success" :
                                order.status === "On Delivery" ? "bg-warning text-dark" :
                                order.status === "Assigned" ? "bg-info text-dark" :
                                "bg-secondary"
                            }">
                                ${order.status}
                            </span>
                        </p>
                        <p><strong>Rider:</strong> ${order.rider_name || "Not assigned yet"}</p>
                    </div>
                </div>
            `;
        });
}

// REFRESH EVERY 5 SECONDS
setInterval(loadOrderStatus, 5000);
</script>

</body>
</html>
