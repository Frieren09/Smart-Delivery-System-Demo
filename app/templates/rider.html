<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rider Dashboard | Smart Delivery</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-primary px-4">
    <span class="navbar-brand">ðŸš´ Rider Dashboard</span>
    <span class="text-white">Rider ID: {{ rider_id }}</span>
</nav>
<div class="container mt-3">
    <button class="btn btn-outline-primary btn-sm"
            onclick="enableNotifications()">
        ðŸ”” Enable Notifications
    </button>
</div>


<!-- MAIN CONTAINER -->
<div class="container mt-4">
    <h3 class="mb-4">My Active Orders</h3>

    <div id="orders-container">
        <!-- Orders will load here -->
    </div>
</div>

<script>
function loadRiderOrders() {
    fetch("/rider/{{ rider_id }}")
        .then(response => response.text())
        .then(html => {
            // Extract only the orders section
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const orders = doc.querySelector("#orders-container");
            if (orders) {
                document.getElementById("orders-container").innerHTML = orders.innerHTML;
            }
        });
}
</script>

<!-- INITIAL RENDER (SERVER-SIDE) -->
<div class="container mt-4 d-none">
    <div id="orders-container">
        {% if orders %}
            {% for order in orders %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Order #{{ order[0] }}</h5>

                        <p>
                            <strong>Status:</strong>
                            <span class="badge
                                {% if order[1] == 'Assigned' %} bg-info text-dark
                                {% elif order[1] == 'On Delivery' %} bg-warning text-dark
                                {% elif order[1] == 'Completed' %} bg-success
                                {% else %} bg-secondary {% endif %}
                            ">
                                {{ order[1] }}
                            </span>
                        </p>

                        {% if order[1] == 'Assigned' %}
                            <form method="POST" action="/rider/orders/{{ order[0] }}/start">
                                <button class="btn btn-primary btn-sm">
                                    ðŸšš Start Delivery
                                </button>
                            </form>
                        {% endif %}

                        {% if order[1] == 'On Delivery' %}
                            <form method="POST" action="/rider/orders/{{ order[0] }}/complete">
                                <button class="btn btn-success btn-sm">
                                    âœ… Mark as Delivered
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                No active orders assigned to you.
            </div>
        {% endif %}
    </div>
</div>

<script>
/* Auto refresh every 5 seconds */
setInterval(() => {
    fetch("/api/admin/orders")
        .then(res => res.json())
        .then(allOrders => {
            const riderOrders = allOrders.filter(o =>
                o.status === "Assigned" || o.status === "On Delivery"
            );

            let html = "";

            if (riderOrders.length === 0) {
                html = `<div class="alert alert-info">No active orders.</div>`;
            }

            riderOrders.forEach(order => {
                html += `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5>Order #${order.order_id}</h5>

                        <p>
                            <strong>Status:</strong>
                            <span class="badge ${
                                order.status === "Assigned"
                                    ? "bg-info text-dark"
                                    : "bg-warning text-dark"
                            }">
                                ${order.status}
                            </span>
                        </p>

                        ${
                            order.status === "Assigned"
                            ? `
                            <form method="POST" action="/rider/orders/${order.order_id}/start">
                                <button class="btn btn-primary btn-sm">
                                    ðŸšš Start Delivery
                                </button>
                            </form>
                            `
                            : `
                            <form method="POST" action="/rider/orders/${order.order_id}/complete">
                                <button class="btn btn-success btn-sm">
                                    âœ… Mark as Delivered
                                </button>
                            </form>
                            `
                        }
                    </div>
                </div>
                `;
            });

            document.getElementById("orders-container").innerHTML = html;
        });
}, 5000);
</script>

<script>
let notifiedOrders = new Set();

function enableNotifications() {
    if (!("Notification" in window)) {
        alert("This browser does not support notifications.");
        return;
    }

    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            alert("Notifications enabled âœ…");
        }
    });
}

function checkForNewOrders() {
    fetch("/api/admin/orders")
        .then(res => res.json())
        .then(orders => {
            orders.forEach(order => {
                if (
                    order.status === "Assigned" &&
                    !notifiedOrders.has(order.order_id)
                ) {
                    notifiedOrders.add(order.order_id);

                    if (Notification.permission === "granted") {
                        new Notification("ðŸ“¦ New Delivery Assigned", {
                            body: `Order #${order.order_id} is ready for pickup`,
                            icon: "https://cdn-icons-png.flaticon.com/512/2972/2972185.png"
                        });
                    }
                }
            });
        });
}

/* Check every 5 seconds */
setInterval(checkForNewOrders, 5000);
</script>

</body>
</html>
